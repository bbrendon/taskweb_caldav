{% set is_edit = task is not none %}
<div class="p-6">
    <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-semibold text-gray-900">
            {{ 'Edit Task' if is_edit else 'New Task' }}
        </h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded hover:bg-gray-100">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <form
        {% if is_edit %}
            hx-patch="/tasks/{{ task.uid }}"
            hx-target="#task-{{ task.uid }}"
            hx-swap="outerHTML"
        {% else %}
            hx-post="/tasks"
            hx-target="#tasks-container"
            hx-swap="afterbegin"
        {% endif %}
        hx-on::after-request="if(event.detail.successful) closeModal()"
        class="space-y-4"
    >
        <!-- Title -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title <span class="text-red-500">*</span></label>
            <input
                type="text"
                name="title"
                required
                value="{{ task.title if is_edit else '' }}"
                placeholder="Task title"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                autofocus
            >
        </div>

        <!-- Description -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
                name="description"
                rows="3"
                placeholder="Optional description"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            >{{ task.description if is_edit and task.description else '' }}</textarea>
        </div>

        <!-- Row: Due + Priority -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                <input
                    type="date"
                    name="due"
                    value="{{ task.due.isoformat() if is_edit and task.due else '' }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select
                    name="priority"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                >
                    <option value="0" {{ 'selected' if not is_edit or task.priority == 0 else '' }}>None</option>
                    <option value="1" {{ 'selected' if is_edit and task.priority == 1 else '' }}>High</option>
                    <option value="5" {{ 'selected' if is_edit and task.priority == 5 else '' }}>Medium</option>
                    <option value="9" {{ 'selected' if is_edit and task.priority == 9 else '' }}>Low</option>
                </select>
            </div>
        </div>

        <!-- Tags -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
            <!-- Preserve the internal "favorite" tag across edits via hidden field -->
            <input type="hidden" name="is_favorite" value="{{ '1' if is_edit and task.is_favorite else '0' }}">
            <input
                type="text"
                name="tags"
                id="tags-input"
                value="{{ task.tags | reject('equalto', 'favorite') | join(', ') if is_edit else '' }}"
                placeholder="work, home, urgent (comma-separated)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <p class="text-xs text-gray-400 mt-1">Separate tags with commas</p>
        </div>

        <!-- Row: Status + Recurrence -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                    name="status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                >
                    <option value="NEEDS-ACTION" {{ 'selected' if not is_edit or task.status == 'NEEDS-ACTION' else '' }}>Pending</option>
                    <option value="IN-PROCESS" {{ 'selected' if is_edit and task.status == 'IN-PROCESS' else '' }}>In Progress</option>
                    <option value="COMPLETED" {{ 'selected' if is_edit and task.status == 'COMPLETED' else '' }}>Completed</option>
                    <option value="CANCELLED" {{ 'selected' if is_edit and task.status == 'CANCELLED' else '' }}>Cancelled</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Recurrence</label>
                <select
                    name="recurrence"
                    id="recurrence-select"
                    onchange="handleRecurrenceChange(this)"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                >
                    {% set rrule = task.recurrence if is_edit else None %}
                    <option value="none" {{ 'selected' if not rrule else '' }}>None</option>
                    <option value="FREQ=DAILY" {{ 'selected' if rrule == 'FREQ=DAILY' else '' }}>Daily</option>
                    <option value="FREQ=WEEKLY" {{ 'selected' if rrule == 'FREQ=WEEKLY' else '' }}>Weekly</option>
                    <option value="FREQ=WEEKLY;INTERVAL=2" {{ 'selected' if rrule == 'FREQ=WEEKLY;INTERVAL=2' else '' }}>Bi-weekly</option>
                    <option value="FREQ=MONTHLY" {{ 'selected' if rrule == 'FREQ=MONTHLY' else '' }}>Monthly</option>
                    <option value="FREQ=YEARLY" {{ 'selected' if rrule == 'FREQ=YEARLY' else '' }}>Yearly</option>
                    <option value="custom" {{ 'selected' if rrule and rrule not in ['FREQ=DAILY','FREQ=WEEKLY','FREQ=WEEKLY;INTERVAL=2','FREQ=MONTHLY','FREQ=YEARLY'] else '' }}>Custom</option>
                </select>
            </div>
        </div>

        <!-- Custom RRULE input -->
        <div id="custom-rrule-container" class="{{ 'hidden' if not (is_edit and task.recurrence and task.recurrence not in ['FREQ=DAILY','FREQ=WEEKLY','FREQ=WEEKLY;INTERVAL=2','FREQ=MONTHLY','FREQ=YEARLY']) else '' }}">
            <label class="block text-sm font-medium text-gray-700 mb-1">Custom RRULE</label>
            <input
                type="text"
                name="recurrence"
                id="custom-rrule-input"
                value="{{ task.recurrence if is_edit and task.recurrence else '' }}"
                placeholder="e.g. FREQ=WEEKLY;BYDAY=MO,WE,FR"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <p class="text-xs text-gray-400 mt-1">
                <a href="https://icalendar.org/iCalendar-RFC-5545/3-8-5-3-recurrence-rule.html" target="_blank" class="underline hover:text-blue-500">RRULE syntax reference</a>
            </p>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-gray-100">
            <button
                type="button"
                onclick="closeModal()"
                class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
            >
                Cancel
            </button>
            <button
                type="submit"
                class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors"
            >
                {{ 'Save Changes' if is_edit else 'Create Task' }}
            </button>
        </div>
    </form>
</div>
