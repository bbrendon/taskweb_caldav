{% set is_edit = task is not none %}
<div class="p-6">
    <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-semibold text-gray-100">
            {{ 'Edit Task' if is_edit else 'New Task' }}
        </h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-200 transition-colors p-1 rounded hover:bg-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <form
        {% if is_edit %}
            hx-patch="/tasks/{{ task.uid }}"
            hx-target="#task-{{ task.uid }}"
            hx-swap="outerHTML"
        {% else %}
            hx-post="/tasks"
            hx-target="#tasks-container"
            hx-swap="afterbegin"
        {% endif %}
        hx-on::after-request="if(event.detail.successful) closeModal()"
        class="space-y-4"
    >
        <!-- Title -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Title <span class="text-red-400">*</span></label>
            <input
                type="text"
                name="title"
                required
                value="{{ task.title if is_edit else '' }}"
                placeholder="Task title"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                autofocus
            >
        </div>

        <!-- Description -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
            <textarea
                name="description"
                rows="3"
                placeholder="Optional description"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            >{{ task.description if is_edit and task.description else '' }}</textarea>
        </div>

        <!-- Location -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Location Alert</label>

            <!-- Hidden inputs submitted with the form -->
            <input type="hidden" name="location_title" id="loc-title-input"
                   value="{{ task.location_alarm.title if is_edit and task.location_alarm else '' }}">
            <input type="hidden" name="location_address" id="loc-address-input"
                   value="{{ task.location_alarm.address if is_edit and task.location_alarm else '' }}">
            <input type="hidden" name="location_lat" id="loc-lat-input"
                   value="{{ task.location_alarm.lat if is_edit and task.location_alarm else '' }}">
            <input type="hidden" name="location_lng" id="loc-lng-input"
                   value="{{ task.location_alarm.lng if is_edit and task.location_alarm else '' }}">

            <!-- Selected state (shown when a location is chosen) -->
            <div id="loc-selected"
                 class="{{ '' if is_edit and task.location_alarm else 'hidden' }} flex items-center gap-2 p-2 bg-green-900 border border-green-700 rounded-lg text-sm">
                <svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span id="loc-selected-label" class="flex-1 font-medium text-green-200 truncate">
                    {{ task.location_alarm.title if is_edit and task.location_alarm else '' }}
                </span>
                <select name="location_proximity" id="loc-proximity-select"
                        class="text-xs border border-green-700 rounded px-1 py-0.5 bg-gray-700 text-green-200 focus:outline-none focus:ring-1 focus:ring-green-500">
                    <option value="ARRIVE" {{ 'selected' if is_edit and task.location_alarm and task.location_alarm.proximity == 'ARRIVE' else '' }}>Arriving</option>
                    <option value="DEPART" {{ 'selected' if is_edit and task.location_alarm and task.location_alarm.proximity == 'DEPART' else '' }}>Departing</option>
                    <option value="CONNECT" {{ 'selected' if is_edit and task.location_alarm and task.location_alarm.proximity == 'CONNECT' else '' }}>Getting In Car</option>
                    <option value="DISCONNECT" {{ 'selected' if is_edit and task.location_alarm and task.location_alarm.proximity == 'DISCONNECT' else '' }}>Getting Out Of Car</option>
                </select>
                <button type="button" onclick="clearLocation()"
                        class="text-green-400 hover:text-red-400 transition-colors ml-1" title="Remove location">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Search / preset UI (hidden when location is selected) -->
            <div id="loc-picker" class="{{ 'hidden' if is_edit and task.location_alarm else '' }}">
                <!-- Car / GPS trigger buttons -->
                <div class="flex flex-wrap gap-2 mb-2">
                    <button type="button"
                            data-preset='{"title": "Getting In Car", "address": "", "lat": null, "lng": null, "proximity": "CONNECT"}'
                            class="loc-preset-btn inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-gray-700 hover:bg-blue-900 hover:text-blue-300 border border-gray-600 rounded-full transition-colors text-gray-300">
                        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke-width="2"/><path stroke-linecap="round" stroke-width="2" d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg>
                        Getting In Car
                    </button>
                    <button type="button"
                            data-preset='{"title": "Getting Out Of Car", "address": "", "lat": null, "lng": null, "proximity": "DISCONNECT"}'
                            class="loc-preset-btn inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-gray-700 hover:bg-blue-900 hover:text-blue-300 border border-gray-600 rounded-full transition-colors text-gray-300">
                        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" stroke-width="2"/><path stroke-linecap="round" stroke-width="2" d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg>
                        Getting Out Of Car
                    </button>
                    <button type="button"
                            data-gps-title="My Location" data-gps-proximity="ARRIVE"
                            class="loc-gps-btn inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-gray-700 hover:bg-purple-900 hover:text-purple-300 border border-gray-600 rounded-full transition-colors text-gray-300">
                        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Current Location
                    </button>
                </div>

                <!-- Preset trigger buttons: arriving + leaving for each preset location -->
                {% if preset_locations %}
                <div class="flex flex-wrap gap-2 mb-2">
                    {% for p in preset_locations %}
                    <button type="button"
                            data-preset='{{ {"title": p.title, "address": p.address, "lat": p.lat, "lng": p.lng, "proximity": "ARRIVE"} | tojson }}'
                            class="loc-preset-btn inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-gray-700 hover:bg-green-900 hover:text-green-300 border border-gray-600 rounded-full transition-colors text-gray-300">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Arriving {{ p.title }}
                    </button>
                    <button type="button"
                            data-preset='{{ {"title": p.title, "address": p.address, "lat": p.lat, "lng": p.lng, "proximity": "DEPART"} | tojson }}'
                            class="loc-preset-btn inline-flex items-center gap-1 px-2.5 py-1 text-xs bg-gray-700 hover:bg-orange-900 hover:text-orange-300 border border-gray-600 rounded-full transition-colors text-gray-300">
                        <svg class="w-3 h-3 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Leaving {{ p.title }}
                    </button>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Search input -->
                <div class="relative">
                    <input
                        type="text"
                        id="loc-search-input"
                        placeholder="Search for a placeâ€¦"
                        autocomplete="off"
                        class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <!-- Dropdown results -->
                    <div id="loc-dropdown"
                         class="hidden absolute z-50 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>

        <!-- Row: Due + Priority -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Due Date</label>
                <input
                    type="date"
                    name="due"
                    value="{{ task.due.isoformat() if is_edit and task.due else '' }}"
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Priority</label>
                <select
                    name="priority"
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                    <option value="0" {{ 'selected' if not is_edit or task.priority == 0 else '' }}>None</option>
                    <option value="1" {{ 'selected' if is_edit and task.priority == 1 else '' }}>High</option>
                    <option value="5" {{ 'selected' if is_edit and task.priority == 5 else '' }}>Medium</option>
                    <option value="9" {{ 'selected' if is_edit and task.priority == 9 else '' }}>Low</option>
                </select>
            </div>
        </div>

        <!-- Tags -->
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
            <!-- Preserve the internal "fav" tag across edits via hidden field -->
            <input type="hidden" name="is_favorite" value="{{ '1' if is_edit and task.is_favorite else '0' }}">
            <input
                type="text"
                name="tags"
                id="tags-input"
                value="{{ task.tags | reject('equalto', 'favorite') | join(', ') if is_edit else '' }}"
                placeholder="work, home, urgent (comma-separated)"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <p class="text-xs text-gray-500 mt-1">Separate tags with commas</p>
        </div>

        <!-- Row: Status + Recurrence -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                <select
                    name="status"
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                    <option value="NEEDS-ACTION" {{ 'selected' if not is_edit or task.status == 'NEEDS-ACTION' else '' }}>Pending</option>
                    <option value="IN-PROCESS" {{ 'selected' if is_edit and task.status == 'IN-PROCESS' else '' }}>In Progress</option>
                    <option value="COMPLETED" {{ 'selected' if is_edit and task.status == 'COMPLETED' else '' }}>Completed</option>
                    <option value="CANCELLED" {{ 'selected' if is_edit and task.status == 'CANCELLED' else '' }}>Cancelled</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Recurrence</label>
                <select
                    name="recurrence"
                    id="recurrence-select"
                    onchange="handleRecurrenceChange(this)"
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                    {% set rrule = task.recurrence if is_edit else None %}
                    <option value="none" {{ 'selected' if not rrule else '' }}>None</option>
                    <option value="FREQ=DAILY" {{ 'selected' if rrule == 'FREQ=DAILY' else '' }}>Daily</option>
                    <option value="FREQ=WEEKLY" {{ 'selected' if rrule == 'FREQ=WEEKLY' else '' }}>Weekly</option>
                    <option value="FREQ=WEEKLY;INTERVAL=2" {{ 'selected' if rrule == 'FREQ=WEEKLY;INTERVAL=2' else '' }}>Bi-weekly</option>
                    <option value="FREQ=MONTHLY" {{ 'selected' if rrule == 'FREQ=MONTHLY' else '' }}>Monthly</option>
                    <option value="FREQ=YEARLY" {{ 'selected' if rrule == 'FREQ=YEARLY' else '' }}>Yearly</option>
                    <option value="custom" {{ 'selected' if rrule and rrule not in ['FREQ=DAILY','FREQ=WEEKLY','FREQ=WEEKLY;INTERVAL=2','FREQ=MONTHLY','FREQ=YEARLY'] else '' }}>Custom</option>
                </select>
            </div>
        </div>

        <!-- Custom RRULE input -->
        <div id="custom-rrule-container" class="{{ 'hidden' if not (is_edit and task.recurrence and task.recurrence not in ['FREQ=DAILY','FREQ=WEEKLY','FREQ=WEEKLY;INTERVAL=2','FREQ=MONTHLY','FREQ=YEARLY']) else '' }}">
            <label class="block text-sm font-medium text-gray-300 mb-1">Custom RRULE</label>
            <input
                type="text"
                name="recurrence"
                id="custom-rrule-input"
                value="{{ task.recurrence if is_edit and task.recurrence else '' }}"
                placeholder="e.g. FREQ=WEEKLY;BYDAY=MO,WE,FR"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
            <p class="text-xs text-gray-500 mt-1">
                <a href="https://icalendar.org/iCalendar-RFC-5545/3-8-5-3-recurrence-rule.html" target="_blank" class="underline hover:text-blue-400">RRULE syntax reference</a>
            </p>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-gray-700">
            <button
                type="button"
                onclick="closeModal()"
                class="px-4 py-2 text-sm text-gray-400 hover:text-gray-100 hover:bg-gray-700 rounded-lg transition-colors"
            >
                Cancel
            </button>
            <button
                type="submit"
                class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors"
            >
                {{ 'Save Changes' if is_edit else 'Create Task' }}
            </button>
        </div>
    </form>
</div>

<script>
(function() {
    initLocationSearch();
})();
</script>
